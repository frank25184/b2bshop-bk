{"version":3,"file":"index.js","names":["_cookie","require","_httpErrors","_interopRequireDefault","_cookieSignature","_tokens","_interopRequireWildcard","e","t","WeakMap","r","n","__esModule","o","i","f","__proto__","default","has","get","set","hasOwnProperty","call","Object","defineProperty","getOwnPropertyDescriptor","getCookieOptions","options","undefined","opts","key","path","value","entries","defaultValue","req","body","_csrf","query","headers","getIgnoredMethods","methods","obj","method","toUpperCase","getSecretBag","sessionKey","cookie","cookieKey","signed","getSecret","bag","Error","setCookie","res","name","val","data","serialize","rawPrev","getHeader","prev","toString","header","Array","isArray","concat","setHeader","setSecret","secret","sign","csrfSecret","verifyConfiguration","csurf","tokens","Tokens","ignoreMethods","TypeError","ignoreMethod","next","token","csrfToken","sec","secretSync","create","verify","createError","code","_default","exports"],"sources":["../../src/index.ts"],"sourcesContent":["import type { NextFunction, Request, Response } from 'express';\n\nimport { type SerializeOptions, serialize } from 'cookie';\nimport createError from 'http-errors';\nimport { sign } from 'cookie-signature';\nimport Tokens, { type Options as TokensOptions, verify } from './tokens';\n\ndeclare global {\n  // eslint-disable-next-line @typescript-eslint/no-namespace\n  namespace Express {\n    // eslint-disable-next-line @typescript-eslint/consistent-type-definitions\n    interface Request {\n      // The CSRF token generation routine, added by this library.\n      csrfToken: () => string;\n\n      // Cookie-signature secret, configured and set by \"cookie-parser\" middleware,\n      // if that is configured to support signed cookies:\n      // https://github.com/expressjs/cookie-parser\n      secret?: string;\n    }\n  }\n}\n\n// TODO: This should come from a cookie library.\ntype CookieOptions = {\n  domain?: string;\n  httpOnly?: boolean;\n  key: string;\n  maxAge?: number;\n  path: string;\n  sameSite?: 'lax' | 'none' | 'strict' | true;\n  secure?: boolean;\n  signed?: boolean;\n};\n\nexport type Options = TokensOptions & {\n  cookie?: true | CookieOptions;\n  ignoreMethods?: string[];\n  sessionKey?: string;\n  value?: (req: Request) => string;\n};\n\n/**\n * Get options for cookie.\n *\n * @param {boolean|object} [options]\n */\nfunction getCookieOptions(\n  options: boolean | Partial<CookieOptions> | undefined,\n): CookieOptions | undefined {\n  if (options !== true && typeof options !== 'object') {\n    return undefined;\n  }\n\n  const opts: CookieOptions = {\n    key: '_csrf',\n    path: '/',\n  };\n\n  if (typeof options === 'object') {\n    for (const [key, value] of Object.entries(options)) {\n      // TODO: It actually breaks one of existing tests, if we don't check\n      // for it. Perhaps, we should correct typings, or do some other refactoring\n      // to avoid this.\n      // eslint-disable-next-line @typescript-eslint/no-unnecessary-condition\n      if (value !== undefined) {\n        (opts[key as keyof CookieOptions] as unknown) = value;\n      }\n    }\n  }\n\n  return opts;\n}\n\n/**\n * Default value function, checking the `req.body`\n * and `req.query` for the CSRF token.\n *\n * @param req\n * @return\n */\nfunction defaultValue(req: Request<unknown, unknown, undefined | {\n  _csrf?: string;\n}, undefined | {\n  _csrf?: string;\n}>): string {\n  /* eslint-disable @typescript-eslint/prefer-nullish-coalescing */\n  // eslint-disable-next-line no-underscore-dangle\n  return (req.body?._csrf || req.query?._csrf\n    || req.headers['csrf-token']\n    || req.headers['xsrf-token']\n    || req.headers['x-csrf-token']\n    || req.headers['x-xsrf-token']) as string;\n  /* eslint-enable @typescript-eslint/prefer-nullish-coalescing */\n}\n\n// TODO: Actually, we should type `methods` stricter, limiting it to the valid\n// method name literals.\n/**\n * Get a lookup of ignored methods.\n *\n * @param {array} methods\n * @returns {object}\n * @api private\n */\nfunction getIgnoredMethods(methods: string[]): Record<string, true> {\n  const obj: Record<string, true> = {};\n\n  for (const method of methods) {\n    obj[method.toUpperCase()] = true;\n  }\n\n  return obj;\n}\n\ntype SecretBag = Record<string, string>;\n\n/**\n * Get the token secret bag from the request.\n *\n * @param {IncomingMessage} req\n * @param {String} sessionKey\n * @param {Object} [cookie]\n * @api private\n */\nfunction getSecretBag(\n  req: Request,\n  sessionKey: string,\n  cookie: CookieOptions | undefined,\n): SecretBag | undefined {\n  if (cookie) {\n    // get secret from cookie\n    const cookieKey = cookie.signed\n      ? 'signedCookies'\n      : 'cookies';\n\n    return req[cookieKey] as SecretBag;\n  }\n\n  // TODO: A less forceful type casting would be nice to have here.\n  // get secret from session\n  return (req as unknown as Record<string, unknown>)[sessionKey] as SecretBag;\n}\n\n/**\n * Get the token secret from the request.\n *\n * @param {IncomingMessage} req\n * @param {String} sessionKey\n * @param {Object} [cookie]\n * @api private\n */\nfunction getSecret(\n  req: Request,\n  sessionKey: string,\n  cookie: CookieOptions | undefined,\n) {\n  // get the bag & key\n  const bag = getSecretBag(req, sessionKey, cookie);\n  // eslint-disable-next-line @typescript-eslint/prefer-nullish-coalescing\n  const key = cookie?.key || 'csrfSecret';\n\n  if (!bag) {\n    throw new Error('misconfigured csrf');\n  }\n\n  // return secret from bag\n  return bag[key];\n}\n\n/**\n * Set a cookie on the HTTP response.\n *\n * @param {OutgoingMessage} res\n * @param {string} name\n * @param {string} val\n * @param {Object} [options]\n * @api private\n */\nfunction setCookie(\n  res: Response,\n  name: string,\n  val: string,\n  options: SerializeOptions,\n) {\n  const data = serialize(name, val, options);\n  // eslint-disable-next-line @typescript-eslint/prefer-nullish-coalescing\n  const rawPrev = res.getHeader('set-cookie') || [];\n  const prev = typeof rawPrev === 'number' ? rawPrev.toString() : rawPrev;\n  const header = Array.isArray(prev) ? prev.concat(data)\n    : [prev, data];\n\n  res.setHeader('set-cookie', header);\n}\n\n/**\n * Set the token secret on the request.\n *\n * @param {IncomingMessage} req\n * @param {OutgoingMessage} res\n * @param {string} sessionKey\n * @param {string} val\n * @param {Object} [cookie]\n * @api private\n */\nfunction setSecret(\n  req: Request,\n  res: Response,\n  sessionKey: string,\n  val: string,\n  cookie?: CookieOptions,\n) {\n  if (cookie) {\n    // set secret on cookie\n    let value = val;\n\n    if (cookie.signed) {\n      // NOTE: This one is not expected to be hit, as if the cookie signature\n      // secret is not properly configured via \"cookie-parser\" middleware, that\n      // is checked and throws earlier in the code.\n      if (!req.secret) throw Error('Internal error');\n\n      value = `s:${sign(val, req.secret)}`;\n    }\n\n    setCookie(res, cookie.key, value, cookie);\n  } else {\n    // set secret on session\n    // TODO: Can we type it in a better way, to avoid such forced type-cast?\n    // eslint-disable-next-line no-param-reassign\n    (req as unknown as Record<string, { csrfSecret: string }>)[sessionKey]!\n      .csrfSecret = val;\n  }\n}\n\n/**\n * Verify the configuration against the request.\n * @private\n */\nfunction verifyConfiguration(\n  req: Request,\n  sessionKey: string,\n  cookie: CookieOptions | undefined,\n): boolean {\n  if (!getSecretBag(req, sessionKey, cookie)) {\n    return false;\n  }\n\n  // NOTE: `req.secret` is the cookie signature secret, configured and set by\n  // \"cookie-parser\" middleware: https://github.com/expressjs/cookie-parser\n  if (cookie && cookie.signed && !req.secret) {\n    return false;\n  }\n\n  return true;\n}\n\n/**\n * CSRF protection middleware.\n *\n * This middleware adds a `req.csrfToken()` function to make a token\n * which should be added to requests which mutate\n * state, within a hidden form field, query-string etc. This\n * token is validated against the visitor's session.\n *\n * @param {Object} options\n * @return {Function} middleware\n * @public\n */\nfunction csurf(options: Options = {}) {\n  // get cookie options\n  const cookie = getCookieOptions(options.cookie);\n\n  // get session options\n  // eslint-disable-next-line @typescript-eslint/prefer-nullish-coalescing\n  const sessionKey = options.sessionKey || 'session';\n\n  // get value getter\n  // eslint-disable-next-line @typescript-eslint/prefer-nullish-coalescing\n  const value = options.value || defaultValue;\n\n  // token repo\n  const tokens = new Tokens(options);\n\n  // ignored methods\n  const ignoreMethods = options.ignoreMethods ?? ['GET', 'HEAD', 'OPTIONS'];\n\n  if (!Array.isArray(ignoreMethods)) {\n    throw new TypeError('option ignoreMethods must be an array');\n  }\n\n  // generate lookup\n  const ignoreMethod = getIgnoredMethods(ignoreMethods);\n\n  return (req: Request, res: Response, next: NextFunction): void => {\n    // validate the configuration against request\n    if (!verifyConfiguration(req, sessionKey, cookie)) {\n      next(new Error('misconfigured csrf'));\n      return;\n    }\n\n    // get the secret from the request\n    let secret = getSecret(req, sessionKey, cookie);\n    let token: string;\n\n    // lazy-load token getter\n    // eslint-disable-next-line no-param-reassign\n    req.csrfToken = () => {\n      let sec = cookie ? secret : getSecret(req, sessionKey, cookie);\n\n      // use cached token if secret has not changed\n      if (token && sec === secret) {\n        return token;\n      }\n\n      // generate & set new secret\n      if (sec === undefined) {\n        sec = tokens.secretSync();\n        setSecret(req, res, sessionKey, sec, cookie);\n      }\n\n      // update changed secret\n      secret = sec;\n\n      // create new token\n      token = tokens.create(secret);\n\n      return token;\n    };\n\n    // generate & set secret\n    if (!secret) {\n      secret = tokens.secretSync();\n      setSecret(req, res, sessionKey, secret, cookie);\n    }\n\n    // verify the incoming token\n    if (!ignoreMethod[req.method] && !verify(secret, value(req))) {\n      next(createError(403, 'invalid csrf token', {\n        code: 'EBADCSRFTOKEN',\n      }));\n      return;\n    }\n\n    next();\n  };\n}\n\nexport default csurf;\n"],"mappings":"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","ignoreList":[]}